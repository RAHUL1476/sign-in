var puppeteer = require("puppeteer");
var path = require("path");
var fs = require("fs");
var chromiumVersion = puppeteer._preferredRevision;
var homeDir;
var production  = process.env.production || process.env.npm_config_productionScope || process.env.npm_config_production;
if(process.env.npm_config_puppeteerPath) {
   homeDir = path.join(process.env.npm_config_puppeteerPath,chromiumVersion,"puppeteer");
} else {
    if(production) {
        homeDir = puppeteer._projectRoot;
    } else { 
        homeDir =  path.join(process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'],".lyte",chromiumVersion,"puppeteer");
    }
}
    const browserFetcher = puppeteer.createBrowserFetcher({
        path : homeDir
});
var info = browserFetcher.revisionInfo(chromiumVersion);
if(info.local) {
    console.log("Chromium is already exist in the path "+info.executablePath);
    fs.writeFileSync("puppeteerPath.txt",info.executablePath);
    
} else {
    console.log("Downloading Chromium ......");
    try {
        fs.mkdirSync(homeDir,{recursive : true});
        browserFetcher.download(chromiumVersion).then(function(result) {
            console.log("Chromium is downloaded in the path");
            fs.writeFileSync("puppeteerPath.txt",result.executablePath);
            console.log(result.executablePath);
        });
    } catch(e) {
        if(e.message.indexOf("permission") != -1){
            console.log(e.message);
            // console.log("Change the permission of the root folder "+homeDir);
            // console.log("To change the permission : sudo chmod -R 777 "+homeDir);
            process.exit(2);
        } else {
            console.log(e.message);
            process.exit(2);
        }
    }   
}