

const path = require("path"),
    utils = require("@zoho/lyte-cli-utils");
    fileManipulation = utils.fileManipulation,
    checkForLyteApp = utils.commonCliUtils.checkForLyteApp;
module.exports = function removeSync(options,resolve,reject) {

    let firstArgs = options.cliArgs[1],
        rootPath = options.root;
        cliPath = options.cliRoot;
        commandsObjPath  = path.join(cliPath,"commands.json"),
        commandsObj = JSON.parse(fileManipulation.readSync(commandsObjPath,'utf-8'));
        options.ui.startSpinner({module:'remove',msg: "Removing the  cli extension "+firstArgs+'...'},options);
    let extPath = require.resolve(firstArgs);
    extPath = path.join(extPath.substring(0,extPath.lastIndexOf("node_modules")),"node_modules",firstArgs);
    
    fileManipulation.remove(extPath,function(err) {
        if(err){
            options.multispinner.spinners.remove.text = "Removing the  cli extension failed";
            reject(err);
        } else {
            try {
                let commandsInPackage;
                for(var key in commandsObj) {
                    commandsInPackage = commandsObj[key];
                    if((index = commandsInPackage.indexOf(firstArgs)) != -1){
                        commandsInPackage.splice(index,1);
                    }
                    if(commandsInPackage.length == 0) {
                        delete commandsObj[key];
                    }
                }
                
                fileManipulation.writeSync(commandsObjPath,JSON.stringify(commandsObj,null,' '));
                if(checkForLyteApp(options,"app")) {
                    if(cliPath.indexOf(rootPath) != -1) {
                        let packageJSONPath = path.join(rootPath,"package.json");
                        if(fileManipulation.fileExist(packageJSONPath)) {
                            var packageJSONObj = JSON.parse(fileManipulation.readSync(packageJSONPath,'utf-8'));
                            let cliExtObj = packageJSONObj["cli-addons"]|| {};
                            delete cliExtObj[firstArgs];
                            fileManipulation.writeSync(packageJSONPath,JSON.stringify(packageJSONObj,null,' '));
                        }
                    }
                }
                options.multispinner.spinners.remove.text = "Cli addon removed successfully";
                resolve();
            } catch(e) {
                options.multispinner.spinners.remove.text = "Removing the  cli extension failed";
                reject(e);
            }
        }
    });
    
    
       
};