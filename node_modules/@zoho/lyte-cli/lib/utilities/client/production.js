
var sharedWorkerForProduction = new SharedWorker("sharedproduction.js");
var response = {};
let str = '';
sharedWorkerForProduction.port.onmessage = function(event) {
    response = JSON.parse(event.data.msg);
    var xhr = new XMLHttpRequest();
    xhr.open("GET", 'http://localhost:'+port+'/get',true);
    xhr.send(); 
    var time = new Date().getTime();
    xhr.onreadystatechange = function() {
        if(xhr.readyState === 4 && xhr.status === 200) {                   
            template = JSON.parse(xhr.response);
            componentNames =  Object.keys(template);
            key = componentNames.pop();
            processingKey(key);
            function processingKey(key) {
                var details = template[key];
                var comp= document.createElement("div");
                comp.innerHTML = details;
                document.body.appendChild(comp);  
                getDynamicNodes(key).then(function() {
                    if(componentNames.length) {
                        processingKey(componentNames.pop());
                    } else {
                        console.log("Time to get all the response "+(new Date().getTime()-time)/1000+'s')
                        xhr = new XMLHttpRequest();
                        xhr.open("POST",'http://localhost:'+port+"/post", true);
                        xhr.upload.onloadstart = function() {
                            console.log("Just started");
                        }
                        xhr.upload.onerror = function() {
                            console.log("Error status "+xhr.status);
                        }
                        xhr.upload.onprogress = function(event) {
                            console.log(`Uploaded ${event.loaded} of ${event.total} bytes`);
                            if(event.loaded == event.total) {
                                console.log("Total time "+(new Date().getTime()-time)/1000+'s');
                            }
                        };
                        xhr.onloadend = function() {
                            console.log("end call")
                            if(xhr.status == 200) {
                                console.log("Total time "+(new Date().getTime()-time)/1000+'s');
                                console.log("upload finished");
                            } else {
                                console.log("Total time "+(new Date().getTime()-time)/1000+'s');
                                console.log("upload the failed content "+this.status)
                            }
                        }
                        xhr.setRequestHeader("Content-Type","application/text");                   
                        xhr.send(JSON.stringify(response));
                    }
                });
            }
        }
    };
};
sharedWorkerForProduction.port.start(); 
sharedWorkerForProduction.port.postMessage({msg:"firstTime"});


